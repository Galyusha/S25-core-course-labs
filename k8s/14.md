# Lab 14: Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

### Output of kubectl get po,sts,svc,pvc commands

```bash
PS D:\S25-core-course-labs\k8s> kubectl get po,sts,svc,pvc                         
NAME                                        READY   STATUS      RESTARTS      AGE
pod/dart-app-my-dart-app-777d76b88f-62xqs   1/1     Running     1 (17h ago)   17h
pod/my-django-app-0                         1/1     Running     0             21m
pod/my-django-app-1                         1/1     Running     0             21m
pod/my-django-app-2                         1/1     Running     0             21m
pod/my-django-app-8676cc774f-kgdwf          1/1     Running     0             6m13s
pod/postinstall-hook                        0/1     Completed   0             21m
pod/preinstall-hook                         0/1     Completed   0             7m2s

NAME                             READY   AGE
statefulset.apps/my-django-app   3/3     21m

NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE     
service/dart-app-my-dart-app   NodePort    10.101.243.76   <none>        8081:32501/TCP   17h     
service/kubernetes             ClusterIP   10.96.0.1       <none>        443/TCP          25h     
service/my-django-app          NodePort    10.106.85.140   <none>        8082:32153/TCP   21m     

NAME                                                       STATUS   VOLUME                        
             CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/my-django-app-data-my-django-app-0   Bound    pvc-07775809-3344-4255-a3d6-80bfaa118ad7   10Gi       RWO            standard       <unset>                 28m
persistentvolumeclaim/my-django-app-data-my-django-app-1   Bound    pvc-fb88e79c-9215-48e1-b2df-718eae261222   10Gi       RWO            standard       <unset>                 24m
persistentvolumeclaim/my-django-app-data-my-django-app-2   Bound    pvc-8bb144aa-6826-435c-84f4-a296a70c2c47   10Gi       RWO            standard       <unset>                 21m
PS D:\S25-core-course-labs\k8s> 
```

### Content of visits in each pod

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-0 -- cat /my-django-app-data/visits.txt 
24
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-1 -- cat /my-django-app-data/visits.txt
21
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-2 -- cat /my-django-app-data/visits.txt
28
```

### Why Do Pods Have Different Visit Counts?

In a StatefulSet:

- Each Pod has its own PersistentVolumeClaim (PVC), which means each Pod maintains its own local copy of the `visits.txt` file.

- The ClusterIP service distributes traffic between the Pods, but the distribution may not be perfectly even.

- As a result, the visit counts in `visits.txt` differ between Pods because each Pod tracks its own visits independently.

### Persistent Storage Validation

```bash
PS D:\S25-core-course-labs\k8s> kubectl delete pod my-django-app-0
pod "my-django-app-0" deleted
PS D:\S25-core-course-labs\k8s> kubectl get pvc
NAME                                 STATUS   VOLUME                              
       CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE       
my-django-app-data-my-django-app-0   Bound    pvc-07775809-3344-4255-a3d6-80bfaa118ad7   10Gi       RWO            standard       <unset>                 86m       
my-django-app-data-my-django-app-1   Bound    pvc-fb88e79c-9215-48e1-b2df-718eae261222   10Gi       RWO            standard       <unset>                 83m       
my-django-app-data-my-django-app-2   Bound    pvc-8bb144aa-6826-435c-84f4-a296a70c2c47   10Gi       RWO            standard       <unset>                 79m       
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-0 -- cat /my-django-app-data/visits.txt 
24
```

The new pod is immediately initialized and PVC is not deleted and result of visits is the same.

### Access pods via DNS

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-0 -- nslookup my-django-app-0.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-django-app-0.my-django-app.default.svc.cluster.local
Address: 10.244.0.208

PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-0 -- nslookup my-django-app-1.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   my-django-app-1.my-django-app.default.svc.cluster.local
Address: 10.244.0.197


PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-1 -- nslookup my-django
-app-1.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-django-app-1.my-django-app.default.svc.cluster.local
Address: 10.244.0.197

PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-1 -- nslookup my-django-app-0.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53

Name:   my-django-app-0.my-django-app.default.svc.cluster.local
Address: 10.244.0.208


PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-2 -- nslookup my-django
-app-0.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-django-app-0.my-django-app.default.svc.cluster.local
Address: 10.244.0.208

PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-2 -- nslookup my-django-app-1.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-django-app-1.my-django-app.default.svc.cluster.local
Address: 10.244.0.197

PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-2 -- nslookup my-django-app-2.my-django-app.default.svc.cluster.local
Server:         10.96.0.10
Address:        10.96.0.10:53


Name:   my-django-app-2.my-django-app.default.svc.cluster.local
Address: 10.244.0.205

```

The headless service allows direct DNS resolution of individual pods. Each pod in the StatefulSet has a unique DNS name in the format:

```bash
<pod-name>.<service-name>.<namespace>.svc.cluster.local
```

### Monitoring & Alerts

#### Liveness and Readiness Probes

Liveness probes ensure that the application is running, while readiness probes ensure that the application is ready to serve traffic. For stateful apps, these probes are critical because:

- They prevent traffic from being routed to unhealthy pods.
- They ensure data consistency by only allowing healthy pods to participate in the cluster.

### Ordering Guarantee and Parallel Operations

#### Why Ordering Guarantees Are Unnecessary

Ordering guarantees are unnecessary for this app because:

- The app is stateless at the pod level.
- Each pod operates independently, and there is no dependency between pods.

The StatefulSet is configured to launch and terminate pods in parallel by setting `podManagementPolicy: Parallel`:

```yaml
spec:
  podManagementPolicy: Parallel
```

## Bonus Task: Update Strategies

### StatefulSet to Dart App

```bash
PS D:\S25-core-course-labs\k8s> kubectl get po,sts,svc,pvc
NAME                                        READY   STATUS             RESTARTS        AGE
pod/dart-app-my-dart-app-777d76b88f-62xqs   1/1     Running            4 (75m ago)     21h
pod/my-dart-app-0                           1/1     Running            0               44s
pod/my-dart-app-1                           1/1     Running            0               44s
pod/my-dart-app-2                           1/1     Running            0               44s
pod/my-django-app-0                         1/1     Running            2 (75m ago)     3h19m
pod/my-django-app-1                         1/1     Running            2 (75m ago)     3h19m
pod/my-django-app-2                         1/1     Running            2 (75m ago)     3h19m
pod/my-django-app-7b99d77d6b-m4jd9          1/1     Running            2 (75, ago)     3h57m
pod/postinstall-hook                        0/1     Completed          0               44s
pod/preinstall-hook                         0/1     Completed          0               70s

NAME                             READY   AGE
statefulset.apps/my-dart-app     3/3     44s
statefulset.apps/my-django-app   3/3     3h19m

NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/dart-app-my-dart-app   NodePort    10.101.243.76   <none>        8081:32501/TCP   21h
service/kubernetes             ClusterIP   10.96.0.1       <none>        443/TCP          29h
service/my-dart-app            ClusterIP   10.103.158.10   <none>        8081/TCP         44s
service/my-django-app          ClusterIP   None            <none>        8082/TCP         67m

NAME                                                       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/my-dart-app-data-my-dart-app-0       Bound    pvc-b5fcfe67-0cc8-4870-8464-153aa3964247   10Gi       RWO            standard       <unset>                 44s
persistentvolumeclaim/my-dart-app-data-my-dart-app-1       Bound    pvc-a62b41e4-05dc-479f-8258-abf3e792db8b   10Gi       RWO            standard       <unset>                 44s
persistentvolumeclaim/my-dart-app-data-my-dart-app-2       Bound    pvc-fc87a609-cf18-43c9-b11f-596ba7ce3237   10Gi       RWO            standard       <unset>                 44s
persistentvolumeclaim/my-django-app-data-my-django-app-0   Bound    pvc-07775809-3344-4255-a3d6-80bfaa118ad7   10Gi       RWO            standard       <unset>                 5h1m
persistentvolumeclaim/my-django-app-data-my-django-app-1   Bound    pvc-fb88e79c-9215-48e1-b2df-718eae261222   10Gi       RWO            standard       <unset>                 4h58m
persistentvolumeclaim/my-django-app-data-my-django-app-2   Bound    pvc-8bb144aa-6826-435c-84f4-a296a70c2c47   10Gi       RWO            standard       <unset>                 4h54m
```

StatefulSets in Kubernetes offer two update strategies: **OnDelete** and **RollingUpdate**.

- **OnDelete**: Updates are not automatic; new pods are created only when old ones are manually deleted. This is ideal for scenarios requiring careful control, such as database updates or leader elections, where manual intervention ensures updates are applied safely.

- **RollingUpdate**: Pods are updated gradually (one at a time or in batches) to ensure zero downtime and high availability. It’s perfect for stateful applications needing seamless updates and supports canary testing by updating subsets of pods first.

Compared to Deployments, StatefulSets do not support the **Recreate** strategy (which deletes all pods at once) because they manage stateful applications with persistent storage and must maintain pod identity. Deployments, designed for stateless apps, use RollingUpdate for gradual updates and Recreate for quick, all-or-nothing updates.
