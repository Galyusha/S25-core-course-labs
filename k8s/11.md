# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Create a Secret

```bash
PS D:\S25-core-course-labs\k8s> kubectl create secret generic mysecrets --from-literal=user=myuser --from-literal=password=pass123
secret/mysecrets created
```

### Verify and Decode Secret

```bash
PS D:\S25-core-course-labs\k8s> kubectl get secrets
NAME        TYPE     DATA   AGE
mysecrets   Opaque   2      77s
PS D:\S25-core-course-labs\k8s> kubectl get secret mysecrets -o jsonpath='{.data}'
{"password":"cGFzczEyMw==","user":"bXl1c2Vy"}
PS D:\S25-core-course-labs\k8s> [Text.Encoding]::Utf8.GetString([Convert]::FromBase64String("cGFzczEyMw=="))
pass123
PS D:\S25-core-course-labs\k8s> [Text.Encoding]::Utf8.GetString([Convert]::FromBase64String("bXl1c2Vy"))    
myuser
```

### Manage Secrets with Helm

#### Generate key with gpg

```bash
gpg --gen-key
```

#### Create secrets.yaml

```bash
sops -p ... secrets.yaml
```

#### Check secrets.yaml

```bash
sops -d secrets.yaml
```

#### Install with secrets

```bash
helm secrets install my-django-app ./my-django-app -n default -f ./secrets.yaml
```

#### Output

```bash
[helm-secrets] Decrypt: ./secrets.yaml
NAME: my-django-app
LAST DEPLOYED: Sat Mar  8 22:33:03 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services my-django-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
[helm-secrets] Removed: ./secrets.yaml.dec
```

### Verify the pods are running

```bash
PS D:\S25-core-course-labs\k8s> kubectl get po                                                       
NAME                             READY   STATUS      RESTARTS   AGE
my-django-app-8677f47d58-qfhkx   1/1     Running     0          4m51s
my-django-app-8677f47d58-t6v7v   1/1     Running     0          4m51s
my-django-app-8677f47d58-vdf7t   1/1     Running     0          4m51s
```

### Verify secret inside the pod

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-8677f47d58-qfhkx -- printenv | grep SECRET_USER
SECRET_USER=myuser
PS D:\S25-core-course-labs\k8s> kubectl exec my-django-app-8677f47d58-qfhkx -- printenv | grep SECRET_PASSWORD
SECRET_PASSWORD=pass123
```

## Task 2: Vault Secret Management System

### Install Vault

```bash
PS D:\S25-core-course-labs\k8s> helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
PS D:\S25-core-course-labs\k8s> helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
PS D:\S25-core-course-labs\k8s> helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Sun Mar  9 12:11:43 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
PS D:\S25-core-course-labs\k8s> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          4m29s
vault-agent-injector-66f45b5fd5-ktgxl   1/1     Running   0          4m29s
```

### Set a secret in Vault

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="myuser" password="pass123"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T10:10:18.893401681Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-09T10:10:18.893401681Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    pass123
username    myuser
/ $ exit
```

### Configure Kubernetes Authentification

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

### Manually Define a Kuberenetes Service Account

```bash
PS D:\S25-core-course-labs\k8s> kubectl get serviceaccounts
NAME                   SECRETS   AGE
default                0         13m
vault                  0         11m
vault-agent-injector   0         11m
PS D:\S25-core-course-labs\k8s> kubectl create sa internal-app
serviceaccount/internal-app created
PS D:\S25-core-course-labs\k8s> kubectl get serviceaccounts
NAME                   SECRETS   AGE
default                0         14m
internal-app           0         6s
vault                  0         12m
vault-agent-injector   0         12m
```

### Implement Vault Secrets in my-django-app Helm Chart

```bash
PS D:\S25-core-course-labs\k8s> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
my-django-app-55fdd54665-2rqx4          1/1     Running   0          9m30s
my-django-app-55fdd54665-d7ttg          1/1     Running   0          9m30s
my-django-app-55fdd54665-hfdjm          1/1     Running   0          9m30s
vault-0                                 1/1     Running   0          103m
vault-agent-injector-66f45b5fd5-ktgxl   1/1     Running   0          103m
```

```bash
PS D:\S25-core-course-labs\k8s\my-django-app> kubectl patch deployment my-django-app --patch-file=patch-inject-secrets.yaml
deployment.apps/my-django-app patched
```

```bash
PS D:\S25-core-course-labs\k8s\my-django-app> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
my-django-app-7bcbc7998f-89tnm          2/2     Running   0          31s
my-django-app-7bcbc7998f-bgf6q          2/2     Running   0          35s
my-django-app-7bcbc7998f-wg5mn          2/2     Running   0          27s
vault-0                                 1/1     Running   0          112m
vault-agent-injector-66f45b5fd5-ktgxl   1/1     Running   0          112m
```

```bash
PS D:\S25-core-course-labs\k8s\my-django-app> kubectl exec -it my-django-app-7bcbc7998f-89tnm --container my-django-app -- sh
/app_python $ cd ..
/ $ cat vault/secrets/database-config.txt
data: map[password:pass123 username:myuser]
metadata: map[created_time:2025-03-09T10:10:18.893401681Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

## Bonus Task: Resource Management and Environment Variables

### Resource limits for django app

```bash
Name:                   my-django-app
Namespace:              default
CreationTimestamp:      Sun, 09 Mar 2025 14:37:36 +0300
Labels:                 app.kubernetes.io/instance=my-django-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=my-django-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=my-django-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 3
                        meta.helm.sh/release-name: my-django-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=my-django-app,app.kubernetes.io/name=my-django-app
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=my-django-app
                    app.kubernetes.io/name=my-django-app
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   my-django-app:
    Image:      g1l1a/my-django-app:v2.4
    Port:       8082/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:     100m
      memory:  128Mi
    Environment:
      SECRET_USER:      <set to the key 'user' in secret 'mysecrets'>      Optional: false
      SECRET_PASSWORD:  <set to the key 'password' in secret 'mysecrets'>  Optional: false
    Mounts:             <none>
  Volumes:              <none>
  Node-Selectors:       <none>
  Tolerations:          <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  my-django-app-55fdd54665 (0/0 replicas created), my-django-app-7bcbc7998f (0/0 replicas created)
NewReplicaSet:   my-django-app-6f686f68f (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set my-django-app-6f686f68f from 0 to 1
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled down replica set my-django-app-7bcbc7998f from 3 to 2
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set my-django-app-6f686f68f from 1 to 2
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled down replica set my-django-app-7bcbc7998f from 2 to 1
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled up replica set my-django-app-6f686f68f from 2 to 3
  Normal  ScalingReplicaSet  28m   deployment-controller  Scaled down replica set my-django-app-7bcbc7998f from 1 to 0
```

### Resource limits for dart app

```bash
Name:                   my-dart-app
Namespace:              default
CreationTimestamp:      Sun, 09 Mar 2025 17:38:50 +0300
Labels:                 app.kubernetes.io/instance=my-dart-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=my-dart-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=my-dart-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: my-dart-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=my-dart-app,app.kubernetes.io/name=my-dart-app    
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=my-dart-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=my-dart-app
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=my-dart-app-0.1.0
  Service Account:  my-dart-app
  Containers:
   my-dart-app:
    Image:      g1l1a/my-dart-app:latest
    Port:       8081/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     200m
      memory:  128Mi
    Requests:
      cpu:     200m
      memory:  128Mi
    Environment:
      USER:        sweetie
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   my-dart-app-6867bbff78 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  66s   deployment-controller  Scaled up replica set my-dart-app-6867bbff78 from 0 to 1
```

### Environment Variables in my-django-app

```bash
PS D:\S25-core-course-labs\k8s> kubectl get pods
NAME                                    READY   STATUS      RESTARTS   AGE
my-dart-app-6867bbff78-mzv2h            1/1     Running     0          2m7s
my-django-app-6f686f68f-2nkc6           2/2     Running     0          46m
my-django-app-6f686f68f-7jj77           2/2     Running     0          46m
my-django-app-6f686f68f-hzdxw           2/2     Running     0          46m
postinstall-hook                        0/1     Completed   0          2m7s
preinstall-hook                         0/1     Completed   0          2m31s
vault-0                                 1/1     Running     0          4h37m
vault-agent-injector-66f45b5fd5-ktgxl   1/1     Running     0          4h37m
PS D:\S25-core-course-labs\k8s> kubectl exec -it my-django-app-6f686f68f-2nkc6 --container my-django-
app -- sh 
/app_python $ printenv
VAULT_PORT_8201_TCP_PROTO=tcp
KUBERNETES_PORT=tcp://10.96.0.1:443
VAULT_SERVICE_HOST=10.102.223.210
KUBERNETES_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
MY_DJANGO_APP_SERVICE_PORT_HTTP=8082
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
HOSTNAME=my-django-app-6f686f68f-2nkc6
PYTHON_PIP_VERSION=24.0
SHLVL=1
HOME=/home/appuser
VAULT_PORT_8200_TCP=tcp://10.102.223.210:8200
SECRET_PASSWORD=pass123
VAULT_PORT=tcp://10.102.223.210:8200
VAULT_PORT_8201_TCP=tcp://10.102.223.210:8201
VAULT_SERVICE_PORT=8200
MY_DJANGO_APP_SERVICE_HOST=10.111.44.182
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.99.254.22:443
MY_DJANGO_APP_PORT_8082_TCP_ADDR=10.111.44.182
SECRET_USER=myuser
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.99.254.22
MY_DJANGO_APP_PORT_8082_TCP_PORT=8082
MY_DJANGO_APP_PORT_8082_TCP_PROTO=tcp
MY_DJANGO_APP_PORT=tcp://10.111.44.182:8082
MY_DJANGO_APP_SERVICE_PORT=8082
PYTHON_GET_PIP_URL=https://github.com/pypa/get-pip/raw/dbf0c85f76fb6e1ab42aa672ffca6f0a675d9ee4/public/get-pip.py
TERM=xterm
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.99.254.22:443
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
MY_DJANGO_APP_PORT_8082_TCP=tcp://10.111.44.182:8082
LANG=C.UTF-8
PYTHON_VERSION=3.11.9
PYTHON_SETUPTOOLS_VERSION=65.5.1
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_SERVICE_HOST=10.96.0.1
VAULT_SERVICE_PORT_HTTP=8200
PWD=/app_python
VAULT_PORT_8200_TCP_ADDR=10.102.223.210
PYTHON_GET_PIP_SHA256=dfe9fd5c28dc98b5ac17979a953ea550cec37ae1b47a5116007395bfacff2ab9
VAULT_PORT_8201_TCP_ADDR=10.102.223.210
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.99.254.22
VAULT_PORT_8200_TCP_PROTO=tcp
```

### Environment Variables in my-dart-app

```bash
PS D:\S25-core-course-labs\k8s> kubectl exec -it my-dart-app-6867bbff78-mzv2h --container my-dart-app -- sh  
/usr/share/nginx/html # printenv
VAULT_PORT_8201_TCP_PROTO=tcp
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT=443
VAULT_SERVICE_HOST=10.102.223.210
USER=sweetie
MY_DJANGO_APP_SERVICE_PORT_HTTP=8082
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
MY_DART_APP_PORT_8081_TCP=tcp://10.96.246.204:8081
HOSTNAME=my-dart-app-6867bbff78-mzv2h
SHLVL=1
HOME=/root
VAULT_PORT_8200_TCP=tcp://10.102.223.210:8200
VAULT_PORT_8201_TCP=tcp://10.102.223.210:8201
VAULT_SERVICE_PORT=8200
VAULT_PORT=tcp://10.102.223.210:8200
PKG_RELEASE=1
MY_DJANGO_APP_SERVICE_HOST=10.111.44.182
MY_DJANGO_APP_PORT_8082_TCP_ADDR=10.111.44.182
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.99.254.22:443
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
DYNPKG_RELEASE=1
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.99.254.22
MY_DJANGO_APP_PORT_8082_TCP_PORT=8082
MY_DJANGO_APP_PORT_8082_TCP_PROTO=tcp
MY_DJANGO_APP_SERVICE_PORT=8082
MY_DJANGO_APP_PORT=tcp://10.111.44.182:8082
TERM=xterm
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
NGINX_VERSION=1.27.4
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.99.254.22:443
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
MY_DART_APP_SERVICE_PORT_HTTP=8081
NJS_VERSION=0.8.9
KUBERNETES_PORT_443_TCP_PROTO=tcp
MY_DJANGO_APP_PORT_8082_TCP=tcp://10.111.44.182:8082
NJS_RELEASE=1
MY_DART_APP_SERVICE_HOST=10.96.246.204
MY_DART_APP_PORT_8081_TCP_ADDR=10.96.246.204
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
VAULT_SERVICE_PORT_HTTP=8200
MY_DART_APP_PORT_8081_TCP_PORT=8081
KUBERNETES_SERVICE_HOST=10.96.0.1
PWD=/usr/share/nginx/html
VAULT_PORT_8200_TCP_ADDR=10.102.223.210
MY_DART_APP_PORT_8081_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_ADDR=10.102.223.210
MY_DART_APP_PORT=tcp://10.96.246.204:8081
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
MY_DART_APP_SERVICE_PORT=8081
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.99.254.22
